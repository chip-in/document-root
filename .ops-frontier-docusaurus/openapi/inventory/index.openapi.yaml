openapi: 3.1.1
info:
  title: Chip-in inventory API
  description: |-
    これはChip-in のインベントリにアクセスするためのAPIである。
    アクセス制御は別途OPAで実装される。その仕様は inventory.rego で記述されている。
  contact:
    email: mitsuru@procube.jp
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
  version: 1.0.0
servers:
  - url: https://127.0.0.1:8080
tags:
  - name: realm
    description: マイクロサービスをグループ化するための論理的な区分。'/' などパスとして使用できない文字を含むことはできない。
  - name: zone
    description: API Gateway で外部に露出するDNS上のゾーン
  - name: virtual-host
    description: ゾーンに紐づく仮想ホスト。
  - name: routing-chain
    description: API Gateway でのルーティングチェーン。
  - name: hub
    description: SPNのハブ。
  - name: service
    description: SPN経由で提供されるマイクロサービス
paths:

  /realms:
    get:
      tags:
        - realm
      summary: List all realms.
      description: Returns a list of all realms.
      operationId: listRealms
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Realm'
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags:
        - realm
      summary: Update an existing realm.
      description: Update an existing realm by realm name.
      operationId: updateRealm
      parameters:
        - name: realm
          in: path
          description: realm name to update
          required: true
          schema:
            type: string
      requestBody:
        description: Update an existent realm in the SPN
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Realm'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Realm'
        '400':
          description: Invalid realm name supplied
        '404':
          description: Realm not found
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - realm
      summary: Add a new realm.
      description: Add a new realm.
      operationId: addRealm
      parameters:
        - name: realm
          in: path
          description: realm name of the realm to add
          required: true
          schema:
            type: string
      requestBody:
        description: Create a new realm
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Realm'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Realm'
        '400':
          description: Invalid realm name supplied or the realm already exists
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}:
    get:
      tags:
        - realm
      summary: Find realm by name.
      description: Returns a single realm.
      operationId: getRealmByName
      parameters:
        - name: realm
          in: path
          description: Name of realm to return
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Realm'
        '400':
          description: Invalid realm name supplied
        '404':
          description: Realm not found
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - realm
      summary: Deletes a realm.
      description: Delete a realm.
      operationId: deleteRealm
      parameters:
        - name: realm
          in: path
          description: Realm name to delete
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Realm deleted
        '400':
          description: Invalid realm name value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}/zones:
    put:
      tags:
        - zone
      summary: Update an existing zone.
      description: Update an existing zone by zone name.
      operationId: updateZone
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Update an existent zone in the SPN
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Zone'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Zone'
        '400':
          description: Invalid URN supplied
        '404':
          description: Zone not found
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - zone
      summary: Add a new zone to the SPN.
      description: Add a new zone to the realm.
      operationId: addZone
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Create a new zone in the relam
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Zone'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Zone'
        '400':
          description: Invalid input
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      tags:
        - zone
      summary: Finds Zones
      description: get list of zones.
      operationId: listZones
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Zone'
        '400':
          description: Invalid status value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}/zones/{zone}:
    get:
      tags:
        - zone
      summary: Find zone.
      description: Returns a single zone.
      operationId: getZone
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: zone
          in: path
          description: zone to return
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Zone'
        '400':
          description: Invalid zone supplied
        '404':
          description: Zone not found
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - zone
      summary: Deletes a zone.
      description: Delete a zone.
      operationId: deleteZone
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: zone
          in: path
          description: zone to delete
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Zone deleted
        '400':
          description: Invalid zone value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /realms/{realm}/zones/{zone}/subdomains:
    put:
      tags:
        - subdomain
      summary: Update an existing subdomain.
      description: Update an existing subdomain by subdomain name.
      operationId: updateSubdomain
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: zone
          in: path
          description: Name of zone which subdomain belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Update an existent subdomain in the SPN
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Subdomain'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subdomain'
        '400':
          description: Invalid Name supplied
        '404':
          description: Virtual Host not found
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - subdomain
      description: Add a new subdomain to the zone.
      operationId: addSubdomain
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: zone
          in: path
          description: Name of zone which subdomain belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Create a new subdomain in the zone
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Subdomain'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subdomain'
        '400':
          description: Invalid input
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      tags:
        - subdomain
      description: Finds Virtual Hosts
      operationId: listSubdomains
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: zone
          in: path
          description: Name of zone which subdomain belogs to
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Subdomain'
        '400':
          description: Invalid status value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /realms/{realm}/zones/{zone}/subdomains/{subdomain}:
    get:
      tags:
        - subdomain
      summary: Find subdomain by name.
      description: Returns a single subdomain.
      operationId: getSubdomainByName
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: zone
          in: path
          description: Name of zone which subdomain belogs to
          required: true
          schema:
            type: string
        - name: subdomain
          in: path
          description: Name of subdomain to return
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Subdomain'
        '400':
          description: Invalid Name supplied
        '404':
          description: Virtual Host not found
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - subdomain
      summary: Deletes a subdomain.
      description: Delete a subdomain.
      operationId: deleteSubdomain
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: zone
          in: path
          description: Name of zone which subdomain belogs to
          required: true
          schema:
            type: string
        - name: subdomain
          in: path
          description: Virtual Host URN to delete
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Virtual Host deleted
        '400':
          description: Invalid Name value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}/virtual-hosts:
    put:
      tags:
        - virtual-host
      summary: Update an existing virtual host.
      description: Update an existing virtual host by virtual host name.
      operationId: updateVirtualHost
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Update an existent virtual host in the SPN
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VirtualHost'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VirtualHost'
        '400':
          description: Invalid Name supplied
        '404':
          description: Virtual Host not found
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - virtual-host
      description: Add a new virtual host to the zone.
      operationId: addVirtualHost
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Create a new virtual host in the zone
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VirtualHost'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VirtualHost'
        '400':
          description: Invalid input
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      tags:
        - virtual-host
      description: Finds Virtual Hosts
      operationId: listVirtualHosts
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/VirtualHost'
        '400':
          description: Invalid status value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
  
  /realms/{realm}/virtual-hosts/{virtualHost}:
    get:
      tags:
        - virtual-host
      summary: Find virtual host by name.
      description: Returns a single virtual host.
      operationId: getVirtualHostByName
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: virtualHost
          in: path
          description: Name of virtual host to return
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VirtualHost'
        '400':
          description: Invalid Name supplied
        '404':
          description: Virtual Host not found
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - virtual-host
      summary: Deletes a virtual host.
      description: Delete a virtual host.
      operationId: deleteVirtualHost
      parameters:
        - name: realm
          in: path
          description: relam which zone belogs to
          required: true
          schema:
            type: string
        - name: virtualHost
          in: path
          description: Virtual Host URN to delete
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Virtual Host deleted
        '400':
          description: Invalid Name value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}/routing-chains/:
    put:
      tags:
        - routing-chain
      summary: Update an existing routing chain.
      description: Update an existing routing chain by routing chain name.
      operationId: updateRoutingChain
      parameters:
        - name: realm
          in: path
          description: relam which routing chain belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Update an existent routing chain in the Realm.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoutingChain'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoutingChain'
        '400':
          description: Invalid Name supplied
        '404':
          description: Routing Chain not found
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - routing-chain
      summary: Add a new routing chain to the Realm.
      description: Add a new routing chain to the realm.
      operationId: addRoutingChain
      parameters:
        - name: realm
          in: path
          description: relam which routing chain belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Create a new routing chain in the realm.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RoutingChain'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoutingChain'
        '400':
          description: Invalid input
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      tags:
        - routing-chain
      summary: Finds Routing Chains
      description: get list of routing chains.
      operationId: listRoutingChains
      parameters:
        - name: realm
          in: path
          description: rel

  /realms/{realm}/routing-chains/{routingChainName}:
    get:
      tags:
        - routing-chain
      summary: Find routing chain by name.
      description: Returns a single routing chain.
      operationId: getRoutingChainByName
      parameters:
        - name: realm
          in: path
          description: relam which routing chain belogs to
          required: true
          schema:
            type: string
        - name: routingChainName
          in: path
          description: Name of routing chain to return
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoutingChain'
        '400':
          description: Invalid Name supplied
        '404':
          description: Routing Chain not found
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - routing-chain
      summary: Deletes a routing chain.
      description: Delete a routing chain.
      operationId: deleteRoutingChain
      parameters:
        - name: realm
          in: path
          description: relam which routing chain belogs to
          required: true
          schema:
            type: string
        - name: routingChainName
          in: path
          description: Routing Chain URN to delete
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Routing Chain deleted
        '400':
          description: Invalid Name value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}/hubs:
    put:
      tags:
        - hub
      summary: Update an existing hub.
      description: Update an existing hub by hub name.
      operationId: updateHub
      parameters:
        - name: realm
          in: path
          description: relam which hub belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Update an existent hub in the SPN
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Hub'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Hub'
        '400':
          description: Invalid Name supplied
        '404':
          description: Hub not found
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - hub
      summary: Add a new hub to the SPN.
      description: Add a new hub to the realm.
      operationId: addHub
      parameters:
        - name: realm
          in: path
          description: relam which hub belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Create a new hub in the realm
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Hub'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Hub'
        '400':
          description: Invalid input
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      tags:
        - hub
      summary: Finds Hubs
      description: get list of hubs.
      operationId: listHubs
      parameters:
        - name: realm
          in: path
          description: relam which hub belogs to
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Hub'
        '400':
          description: Invalid status value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}/hubs/{hubName}:
    get:
      tags:
        - hub
      summary: Find hub by name.
      description: Returns a single hub.
      operationId: getHubByName
      parameters:
        - name: realm
          in: path
          description: relam which service belogs to
          required: true
          schema:
            type: string
        - name: hubName
          in: path
          description: Name of hub to return
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Hub'
        '400':
          description: Invalid Name supplied
        '404':
          description: Hub not found
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - hub
      summary: Deletes a hub.
      description: Delete a hub.
      operationId: deleteHub
      parameters:
        - name: hubName
          in: path
          description: Hub URN to delete
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Hub deleted
        '400':
          description: Invalid Name value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}/hubs/{hubName}/services:
    put:
      tags:
        - service
      summary: Update an existing service.
      description: Update an existing service by service Name.
      operationId: updateService
      parameters:
        - name: realm
          in: path
          description: relam which service belogs to
          required: true
          schema:
            type: string
        - name: hubName
          in: path
          description: Name of hub which service belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Update an existent service in the SPN
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Service'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '400':
          description: Invalid Name supplied
        '404':
          description: Service not found
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags:
        - service
      summary: Add a new service to the SPN.
      description: Add a new service to the realm.
      operationId: addService
      parameters:
        - name: realm
          in: path
          description: relam which service belogs to
          required: true
          schema:
            type: string
      requestBody:
        description: Create a new service in the realm
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Service'
        required: true
      responses:
        '200':
          description: Successful operation, return the new contents.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '400':
          description: Invalid input
        '422':
          description: Validation exception
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    get:
      tags:
        - service
      summary: Finds Services
      description: get list of services.
      operationId: listServices
      parameters:
        - name: realm
          in: path
          description: relam which service belogs to
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Service'
        '400':
          description: Invalid status value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /realms/{realm}/hubs/{hubName}/services/{serviceName}:
    get:
      tags:
        - service
      summary: Find service by urn.
      description: Returns a single service.
      operationId: getServiceByName
      parameters:
        - name: realm
          in: path
          description: relam which service belogs to
          required: true
          schema:
            type: string
        - name: hubName
          in: path
          description: Name of hub which service belogs to
          required: true
          schema:
            type: string
        - name: serviceName
          in: path
          description: URN of service to return
          required: true
          schema:
            type: string
      responses:
        '200':
          description: successful operation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Service'
        '400':
          description: Invalid URN supplied
        '404':
          description: Service not found
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags:
        - service
      summary: Deletes a service.
      description: Delete a service.
      operationId: deleteService
      parameters:
        - name: serviceName
          in: path
          description: Service URN to delete
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Service deleted
        '400':
          description: Invalid URN value
        default:
          description: Unexpected error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
components:
  schemas:
    Realm:
      type: object
      required:
        - name
        - title
        - cacert
        - disabled
        - signingKey
      description: |-
        レルムは、SPN内の論理的なグループであり、ゾーンやサブドメイン、仮想ホストなどのリソースを分離して管理するためのコンテナです。
        各レルムは、独自の設定や管理者を持ち、セキュリティやアクセス制御のために使用されます。
      properties:
        name:
          type: string
          pattern: '^[a-z0-9][a-z0-9-]*$'
          description: |-
            レルムの名前。URN の一部として使用される。
            文字列は小文字英字、数字、ハイフンのみを含むことができる。
            ただし、ハイフンで始まることはできない。
            名称 "master" は予約されており、使用できない。
          example: example-realm
        title:
          type: string
          description: レルムの日本語名称です。
          example: CMSシステム
        description:
          type: string
          description: レルムの説明文です。
          example: CMSシステムのレルムです。
        cacert:
          type: string
          description: |-
            realm 配下の SPN hub で mTLSにおけるクライアント証明書を発行したCA局の証明書(PEM形式)の文字列
          example: |-
            -----BEGIN CERTIFICATE-----
            MIIDXTCCAkWgAwIBAgIJAL5z1Z2k5b4wMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV
            ...
            -----END CERTIFICATE-----
        signingKey:
          type: string
          minLength: 24
          description: |-
            realm 配下のAPI Gateway でセッショントークンの署名に使用されるパスワード。
            使用できる文字は英字、数字、ハイフン、アンダースコアのみである。
          example: wUAMEUxCzAJBg1m4uS38-2__
        sessionTimeout:
          type: integer
          description: |-
            セッショントークンの有効期限。単位は秒で、デフォルトは 2592000  秒 (30日)。
          example: 2592000 
        administrators:
          type: array
          items:
            type: string
          description: |-
            レルムの管理者のユーザID。ユーザの管理はインベントリでは行わない。認証サービス内でのみ管理され、ここではそのIDのみを参照する。
          example:
            - chip-in-admin@example.com
        expiredAt:
          type: string
          format: date-time
          description: |-
            レルムの有効期限。ISO8601形式で指定する。
            この日時を過ぎると、レルムの disabled フラグは true となり、関連するリソースへのアクセスが制限される。
          example: '2024-12-31T23:59:59Z'
        disabled:
          type: boolean
          description: |-
            レルムが無効化されているかどうかを示すフラグ。
            true の場合、レルムは無効化されており、関連するリソースへのアクセスが制限される。
            false の場合、レルムは有効であり、通常の操作が可能である。
          example: false
      additionalProperties: false

    Zone:
      type: object
      description: |-
        ゾーンは、SPN内のDNSレコードを管理するための論理的なグループであり、仮想ホストのFQDNを収容できる。また、サブドメインを作成し、ゾーン内のFQDNをグループ化することができる。
        特に master レルムのゾーンは、他のレルムにサブドメインを貸し出すことができる。
        各ゾーンは、特定のレルムに属し、そのレルム内で一意の名前を持つ。
        ゾーンは、DNSプロバイダやACME証明書プロバイダと連携して、DNSレコードやSSL/TLS証明書の管理を行う。
      required:
        - zone
        - title
        - realm
      properties:
        zone:
          type: string
          format: hostname
          description: |-
            ゾーンの名前。FQDN のサフィックスとして使用される。
            文字列は小文字英字、数字、ハイフン、ピリオドのみを含むことができる。
          example: example.com
        title:
          type: string
          description: ゾーンの日本語名称です。
          example: CMSシステム検証環境ゾーン
        description:
          type: string
          description: ゾーンの説明文ですです。
          example: CMSシステムの検証環境用のゾーンです。
        realm:
          type: string
          readOnly: true
          format: urn
          description: |-
            ゾーンが属するレルムの名前。
        dnsProvider:
          type: string
          description: |-
            ゾーンのDNSレコードを管理するためのDNSプロバイダのURN。
          example: urn:chip-in:service:example-realm:example-zone-route53
        acmeCertificateProvider:
          type: string
          description: |-
            ゾーンのSSL/TLS証明書を自動的に取得するためのACME証明書プロバイダのURL
          example: https://acme-v02.api.letsencrypt.org/directory
      additionalProperties: false

    Subdomain:
      type: object
      description: |-
        サブドメインは、ゾーン内で定義されるサブドメインのリソースであり、仮想ホストをグループ化して収容することができる。
        各サブドメインは、特定のゾーンに属し、そのゾーン内で一意の名前を持つ。
        master レルムのサブドメインは、他のレルムにサブドメインを貸し出すことができる。
      required:
        - name
        - title
      properties:
        name:
          type: string
          pattern: '^[a-z0-9][a-z0-9-]*$'
          description: |-
            サブドメインの名前。ゾーン名と結合して FQDN を得ることができる。
            文字列は小文字英字、数字、ハイフンのみを含むことができる。
            ただし、先頭がハイフンであってはならない。
            たとえば、 stg というサブドメイン名でゾーンの名前が example.com の場合、
            stg.example.com というサブドメインを構成し、www.stg.example.com, login.stg.example.com  というような
            FQDN の仮想ホストを収容することができる。
          example: stg
        fqdn:
          type: string
          readOnly: true
          format: hostname
          description: |-
            サブドメインの完全修飾ドメイン名(FQDN)。
            たとえば、 stg.example.com のように、ゾーン名と結合して得られる。
            このFQDNは、サブドメイン内の仮想ホストのFQDNのベースとなる。
          example: stg.example.com
        zone:
          type: string
          readOnly: true
          format: urn
          description: |-
            このサブドメインが属するゾーンのURN。
            ゾーンは、サブドメインのFQDNのサフィックスとして使用される。
            たとえば、 stg.example.com の場合、ゾーンは example.com となる。
          example: urn:chip-in:zone:example-realm:example.com
        title:
          type: string
          description: サブドメインの名称です。
          example: CMSシステム
        description:
          type: string
          description: サブドメインの説明文です。
          example: CMSシステムのWebUI を提供するサブドメインです。
        destinationRealm:
          type: string
          description: |-
            このサブドメインの貸出先レルムののURN。
          example: urn:chip-in:realm:example-realm
        shareCookie:
          type: boolean
          default: false
          description: |-
            このフラグが指定されると、配下の仮想ホストの間でセッション Cookie が共有される。
            すなわち、仮想ホストから発行せれるセッション Cookie の domain 属性にはサブドメインのFQDNが指定される。
            デフォルトでは Cookie に Domain 属性は設定されない。
            サブドメイン配下の仮想ホストのアクセスログ間でセッションによる串刺しが可能になり、シングルサインオンも実装される。
            OIDCやSAMLによるシングルサインオンとは異なり、認証サーバへのリダイレクトは不要となる。
          example: true
      additionalProperties: false

    VirtualHost:
      type: object
      required:
        - name
        - title
        - routingChain
      properties:
        name:
          type: string
          description: |-
            仮想ホストの名前。所属するゾーンや指定したサブドメインの名前と結合して FQDN を得ることができる。
            たとえば、 www という仮想ホスト名でゾーンの名前が example.com の場合、FQDN は www.example.com となる。
          example: www.stg
        title:
          type: string
          description: 仮想ホストの名称。
          example: CMSシステム
        description:
          type: string
          description: 仮想ホストの説明文。
          example: CMSシステムのWebUI を提供する仮想ホストです。
        realm:
          type: string
          readOnly: true
          format: urn
          description: |-
            この仮想ホストが属するレルムのURN。
          example: urn:chip-in:realm:example-realm
        subdomain:
          type: string
          description: |-
            この仮想ホストが属するサブドメインのURN。
            仮想ホストのFQDNは、仮想ホストの名前とサブドメインの名前を結合して得られる。
            たとえば、 www という仮想ホスト名でサブドメインの FQDN が stg.example.com の場合、FQDN は www.stg.example.com となる。
            サブドメインは自身のレルムに属するものかサブドメインの貸出先に自身のレルムが指定されているものでなくてはならない。
            サブドメインが指定されていない場合は、仮想ホストはゾーン直下のFQDNを持つことになる。
          example: urn:chip-in:subdomain:example-realm:stg
        routingChain:
          type: string
          description: |-
            この仮想ホストに紐づくルーティングチェーンのURN。
            ルーティングチェーンは、リクエストの処理を行うためのルールの集合であり、リクエストを適切なマイクロサービスに転送するためのロジックを定義する。
          example: urn:chip-in:routing-chain:example-realm:cms-chain
        certificate:
          type: array
          items:
            type: string
            description: |-
              この仮想ホストのサーバ証明書。PEM形式の証明書を指定する。
              証明書は、HTTPS通信を行うために必要であり、仮想ホストが提供するサービスのセキュリティを確保する。
            example: |-
              -----BEGIN CERTIFICATE-----
              MIIDXTCCAkWgAwIBAgIJAL5z1Z2k5b4wMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV
              ...
              -----END CERTIFICATE-----
        key:
          type: string
          description: |-
            この仮想ホストのサーバ証明書の秘密鍵。PEM形式の秘密鍵を指定する。
            秘密鍵は、HTTPS通信を行うために必要であり、仮想ホストが提供するサービスのセキュリティを確保する。
          example: |-
            -----BEGIN RSA PRIVATE KEY-----
            MIIEpAIBAAKCAQEA7v1z1Z2k5b4wMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNVBAYT
            ...
            -----END RSA PRIVATE KEY-----
        disabled:
          type: boolean
          description: |-
            仮想ホストが無効化されているかどうかを示すフラグ。
            true の場合、仮想ホストは無効化されており、仮想ホストは削除され、アクセスは拒否される（TLSの場合、SSL_ERROR_HANDSHAKE_FAILURE を返し、平文の場合、400 Bad Request が返す）。
            false の場合、仮想ホストは有効であり、アクセスが可能である。
          example: false
      additionalProperties: false

    RoutingChain:
      type: object
      required:
        - name
        - title
      properties:
        name:
          type: string
          description: |-
            ルーティングチェーンの名前。URN の一部として使用される。
            文字列は小文字英字、数字、ハイフン、アンダースコアのみを含むことができる。
          example: cms-chain
        realm:
          type: string
          readOnly: true
          format: urn
          description: |-
            ルーティングチェインが属するレルムの名前。
          example: urn:chip-in:realm:example-realm
        urn:
          type: string
          readOnly: true
          description: |-
            ルーティングチェーンのurn。
          example: urn:chip-in:routing-chain:example-realm:cms-chain
        title:
          type: string
          description: |-
            ルーティングチェーンの日本語名称です。
          example: CMSシステムルーティングチェーン
        description:
          type: string
          description: |-
            ルーティングチェーンの説明文です。
            
          example: CMSシステムのWebUI を提供するルーティングチェーンです。
        rules:
          type: array
          description: |-
            ルーティングチェーンのルールのリスト。各ルールは、リクエストを処理するための条件とアクションを定義する。
            ルールは、リクエストのパスやヘッダなどを照合し、適切なアクションを実行するために使用される。
          items:
            type: object
            required:
              - match
              - action
            description: |-
              ルーティングチェーンのルール。各ルールは、リクエストを処理するための条件とアクションを定義する。
              ルールは、リクエストのパスやヘッダなどを照合し、
              適切なアクションを実行するために使用される。
            properties:
              match:
                type: string
                description: |-
                  [RHAI](https://rhai.rs/book/about/features.html) の式で、リクエストのパスやヘッダなどを照合するための条件を記述する。
                  '{{' と '}}' で囲む必要はなく、全体が RHAI の式として評価される。
                example: request.path.starts_with("/api") && request.headers["X-Auth-Token"]
              action:
                oneOf:
                  - type: object
                    title: Proxy
                    description: |-
                      リクエストをプロキシ先のサービスに転送するためのアクション。
                      前フェーズまでで作成されたレスポンスは破棄され、プロキシ先サービスから返却されたものが新しいレスポンスとなる。
                      このアクションは、リクエストを別のマイクロサービスに転送するために使用される。
                    properties:
                      type:
                        type: string
                        enum: [proxy]
                      target:
                        type: string
                        description: |-
                          プロキシ先サービスのURN。
                        example: '"urn:chip-in:service:example-realm:cms-service"'
                      noBody:
                        type: boolean
                        description: |-
                          true の場合、リクエストボディは転送されない。
                          デフォルトは false で、リクエストボディは転送される。
                        example: false
                    additionalProperties: false
                  - type: object
                    title: Redirect
                    description: |-
                      リダイレクトを行うためのアクション。レスポンスの stauts は 302 に設定される。
                      リダイレクト先のURLは、レスポンスの Location ヘッダに設定される。
                      このアクションは、リクエストを別のURLに転送するために使用される。
                    properties:
                      type:
                        type: string
                        enum: [redirect]
                      target:
                        type: string
                        description: |-
                          レスポンスの Location ヘッダに設定されるリダイレクト先のURL。
                        example: https://idp.example.com/login
                    additionalProperties: false
                  - type: object
                    title: Jump
                    description: |-
                      別のルーティングチェーンにリクエストを転送するためのアクション。処理中のチェーンは終了し、転送先のチェーンが新たに開始される。
                    properties:
                      type:
                        type: string
                        enum: [jump]
                      target:
                        type: string
                        description: |-
                          ルーティングチェーンのURN。
                        example: urn:chip-in:routing-chain:example-realm:cms-chain
                    additionalProperties: false
                  - type: object
                    title: SetVariables
                    description: |-
                      RHAI の式を評価して、変数に値を設定するアクション。
                      このアクションは、リクエストやレスポンスの情報を参照して、変数に値を設定するために使用される。
                    properties:
                      type:
                        type: string
                        enum: [setVariables]
                      variables:
                        type: object
                        description: |-
                          設定する変数のキーと値のペア。
                        example:
                          savedCookie: "SESSION={{request.sessionID}}; Path=/; Secure; HttpOnly"
                        additionalProperties:
                          type: string
                          description: |-
                            プロパティの値が文字列で、かつ '{{' と '}}' が含まれている場合、その部分は RHAI の式として評価される。
                            RHAI の式内では、リクエストやレスポンスの情報を参照して値を算出することができる。
                            数値や booleanの場合はそのまま出力される。オブジェクトや配列の場合は、JSON文字列に変換されて出力される。
                            プロパティの値が null の場合は、変数は設定されず、設定済みの変数は削除される。
                    additionalProperties: false
                  - type: object
                    title: SetHeaders
                    description: |-
                      HTTP ヘッダーの設定を行うためのアクション。
                      このアクションは、リクエストやレスポンスのヘッダを設定するために使用される。
                    properties:
                      type:
                        type: string
                        enum: [setHeaders]
                      target:
                        type: string
                        enum: [request, response]
                        description: |-
                          ヘッダの設定先。request の場合はリクエストヘッダ、response の場合はレスポンスヘッダ。
                        example: response
                      headers:
                        type: object
                        description: |-
                          設定するヘッダのキーと値のペア。
                        example:
                          content-type: "application/json"
                          'X-Forwarded-For': "{{request.clientIp}}"
                        additionalProperties:
                          type: string
                          description: |-
                            プロパティの値が文字列で、かつ '{{' と '}}' が含まれている場合、その部分は RHAI の式として評価される。
                            RHAI の式内では、リクエストやレスポンスの情報を参照して値を算出することができる。
                            ただし、RHAI 式の評価結果が undefined や null の場合はヘッダは設定されず、設定済みのヘッダは削除される。
                            数値や booleanの場合はそのまま出力される。オブジェクトや配列の場合は、JSON文字列に変換されて出力される。
                            プロパティの値が null の場合は、ヘッダは設定されず、設定済みのヘッダは削除される。
                    additionalProperties: false
                  - type: object
                    title: AccessLog
                    description: |-
                      アクセスログを出力する。
                    properties:
                      type:
                        type: string
                        enum: [accessLog]
                      target:
                        type: string
                        description: |-
                          ログ出力サービスのURN。
                        example: urn:chip-in:servies:example-realm:access-log-service
                      maxValueLength:
                        type: integer
                        default: 512
                        description: |-
                          ログの項目の値の最大長。デフォルトは 512 で、512文字を超える場合は切り捨てられる。
                        example: 512
                      format:
                        type: object
                        description: |-
                          ログ出力のフォーマット。1行1オブジェクトのJSON形式で出力される。
                        example:
                          timestamp: "now()"
                          method: "request.method"
                          path: "request.path"
                          status: "response.status"
                          user: "request.user"
                          groups: "request.groups"
                          role: "request.role"
                          clientIp: "request.clientIp"
                          xff: "request.headers['X-Forwarded-For']"
                          userAgent: "request.headers['User-Agent']"
                          requestTime: "request.time"
                          tat: "response.tat"
                          upstreamStatus: "response.upstreamStatus"
                          upsstreamTAT: "response.upstreamTAT"
                        additionalProperties:
                          type: string
                          description: |-
                            プロパティの値は、'{{' と '}}' で囲む必要はなく、全体が RHAI の式として評価される。
                            RHAI の式内では、リクエストやレスポンスの情報を参照して値を算出することができる。
                            ただし、結果が undefined や null の場合は "-" となる。
                            また、値が文字列であり、かつ、その長さが maxValueLength を超える場合は切り捨てられ、最後に "...truncated" が付加される。
                            数値や booleanの場合はそのまま出力される。オブジェクトや配列の場合は、JSON文字列に変換されて出力される。
                    additionalProperties: false
      additionalProperties: false

    Hub:
      type: object
      required:
        - name
        - title
        - fqdn
        - serverCert
        - serverCertKey
      properties:
        name:
          type: string
          description: |-
            SPN Hub の名前。URN の一部として使用される。
            文字列は小文字英字、数字、ハイフン、アンダースコアのみを含むことができる。
          example: hub1
        realm:
          type: string
          readOnly: true
          format: urn
          description: |-
            SPN Hub が属する realm の URN。
          example: urn:chip-in:realm:example-realm
        urn:
          type: string
          readOnly: true
          description: |-
            SPN Hub のURN。URNは、SPN Hubを一意に識別するための文字列で、以下の形式で構成される。
            urn:chip-in:network:{realm}:{name}
          example: urn:chip-in:network:example-realm:hub1
        title:
          type: string
          description: SPN Hub の日本語名称です。
          example: CMSシステムプライベートネットワークハブ
        description:
          type: string
          description: SPN Hub の説明文です。
          example: CMSシステム用のプライベートネットワークのハブ
        fqdn:
          type: string
          description: SPN Hub のサーバのFQDN
          example: core.stg.chip-in.net
        serverPort:
          type: integer
          description: SPN Hub のサーバのポート番号。デフォルトは 443
          example: 443
        serverCert:
          type: string
          description: |-
            mTLSにおけるサーバ証明書(PEM形式)の文字列。
            SPN Hub のサーバは、この証明書を使用してクライアントとの通信を暗号化する。
          example: |-
            -----BEGIN CERTIFICATE-----
            MIIDXTCCAkWgAwIBAgIJAL5z1Z2k5b4wMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNV
            ...
            -----END CERTIFICATE-----
        serverCertKey:
          type: string
          description: |-
            mTLSにおけるサーバ証明書の秘密鍵(PEM形式)の文字列。
            SPN Hub のサーバは、この秘密鍵を使用してクライアントとの通信を暗号化する。
          example: |-
            -----BEGIN RSA PRIVATE KEY-----
            MIIEpAIBAAKCAQEA7v1z1Z2k5b4wMA0GCSqGSIb3DQEBCwUAMEUxCzAJBgNVBAYT
            ...
            -----END RSA PRIVATE KEY-----
      additionalProperties: false

    Service:
      required:
        - name
        - urn
        - title
        - realm
        - hubName
        - providers
        - consumers
      type: object
      properties:
        name:
          type: string
          description: |-
            サービスの名前。URN の一部として使用される。
            文字列は小文字英字、数字、ハイフン、アンダースコアのみを含むことができる。
            ただし、先頭がハイフンであってはならない。
          example: authz-rbac
        hub:
          type: string
          readOnly: true
          format: urn
          description: |-
            サービスが接続される SPN Hub のURN。
          example: urn:chip-in:network:example-realm:hub1
        urn:
          type: string
          readOnly: true
          description: |-
            サービスのURN。URNは、サービスを一意に識別するための文字列で、以下の形式で構成される。<br/>
            urn:chip-in:service:{realm}:{hubName}:{name}
          example: urn:chip-in:service:example-realm:hub1:authz-rbac
        title:
          type: string
          description: |-
            サービスの日本語名称です。URN の一部として使用される。
            文字列は日本語を含むことができる。
          example: CMSシステム認可サービス
        description:
          type: string
          description: |-
            サービスの説明文です。URN の一部として使用される。
            文字列は日本語を含むことができる。
          example: CMSシステムの認可サービスです。
        realm:
          type: string
          description: |-
            サービスが属するレルムの名前。
        hubName:
          type: string
          description: |-
            サービスが接続される SPN Hub の名前。
            SPN Hub は、サービスの提供を行うためのネットワークハブであり、サービスへのアクセスを管理する。
          example: hub1
        availabilityManagement:
          type: object
          required:
            - clusterManagerUrn
            - serviceId
          description: |-
            コンテナクラスタ内でマイクロサービスのスケジュール起動、オンデマンド起動を行うためのパラメータ
          properties:
            clusterManagerUrn:
              type: string
              description: このサービスを起動できるコンテナクラスタのクラスタマネージャサービスの URN
            serviceId:
              type: string
              description: クラスタ内でのマイクロサービスのID
            startAt:
              type: string
              description: 定時起動する場合の起動スケジュールの CRON 式
              example: 0 22 ? * SUN-THU *
            stopAt:
              type: string
              description: 定時停止する場合の起動スケジュールの CRON 式
              example: 0 9 ? * MON-FRI *
            ondemandStart:
              type: boolean
              description: オンデマンド起動とするか否か。デフォルトは true
            idelTimeout:
              type: int
              description: 通信がない状態が一定時間続くとマイクロ。 ondemadStart が true の場合のみ有効
        providers:
          type: array
          items:
            type: string
          description: |-
            当該サービスの提供が許可されるエンドポイント
            クライアント証明書の Subject の値と照合される
          example:
            - oidc-authz-provider
        consumers:
          type: array
          items:
            type: string
          description: |-
            当該サービスの利用が許可されるエンドポイント
            クライアント証明書の Subject の値と照合される
          example:
            - api-gateway
      additionalProperties: false

    Error:
      type: object
      properties:
        code:
          type: string
        message:
          type: string
      required:
        - code
        - message
      additionalProperties: false

    RealmDefinition:
      type: object
      properties:
        realm:
          $ref: '#/components/schemas/Realm'
          description: |-
            レルムの定義。レルムは、SPNの基本的な単位であり、DNSゾーン、仮想ホスト、ルーティングチェーン、SPN Hub、サービスなどを含む。
        zones:
          type: array
          items:
            $ref: '#/components/schemas/Zone'
          description: |-
            レルムに属するゾーンのリスト。各ゾーンは、DNSレコードを管理するための情報を含む。
        subdomains:
          type: array
          items:
            $ref: '#/components/schemas/Subdomain'
          description: |-
            レルムに属するサブドメインのリスト。
        virtualHosts:
          type: array
          items:
            $ref: '#/components/schemas/VirtualHost'
          description: |-
            レルムに属する仮想ホストのリスト。各仮想ホストは、FQDN、ルーティングチェーン、SSL/TLS証明書などの情報を含む。
        routingChains:
          type: array
          items:
            $ref: '#/components/schemas/RoutingChain'
          description: |-
            レルムに属するルーティングチェーンのリスト。各ルーティングチェーンは、リクエストの処理を行うためのルールの集合を含む。
        hubs:
          type: array
          items:
            $ref: '#/components/schemas/Hub'
          description: |-
            レルムに属する SPN Hub のリスト。各 SPN Hub は、SPN Hub の名前、FQDN、サーバ証明書、サーバ証明書の秘密鍵などの情報を含む。
        services:
          type: array
          items:
            $ref: '#/components/schemas/Service'
          description: |-
            レルムに属するサービスのリスト。各サービスは、サービスの名前、URN、タイトル、説明、提供者、利用者などの情報を含む。 
      additionalProperties: false

  requestBodies:
    Service:
      description: Service object that needs to be added to the SPN
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Service'
